<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="viewport-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØµÙˆÙŠØª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
    <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ØªØ­Ù…ÙŠÙ„ Ø®Ø· Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght[400;600;700]&display=swap" rel="stylesheet">
    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø§ØªØ¬Ø§Ù‡ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ù„Ù„Ø®Ù„ÙÙŠØ© */
        }
        /* ØªØµÙ…ÙŠÙ… Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù… */
        #drawingCanvas {
            cursor: crosshair;
            touch-action: none; /* Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„Ù„Ù…Ø³ */
            background-color: white;
            border: 2px solid #3b82f6; /* Ø­Ø¯ÙˆØ¯ Ø²Ø±Ù‚Ø§Ø¡ */
        }
        /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: auto; /* Ù„ØªÙˆØ³ÙŠØ·Ù‡ */
        }
        .loader.w-4 {
            width: 1rem;
            height: 1rem;
            border-width: 3px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ØªØµÙ…ÙŠÙ… Ø²Ø± TTS Ù„Ø¬Ø¹Ù„Ù‡ Ù…Ù…ÙŠØ²Ø§Ù‹ */
        #readCritiqueButton {
            background-color: #f97316; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
            color: white;
            transition: all 0.2s;
        }
        #readCritiqueButton:hover {
            background-color: #ea580c;
            transform: translateY(-1px);
        }
        /* ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ */
        #visualInterpretationButton {
            background-color: #a21caf; /* Ø¨Ù†ÙØ³Ø¬ÙŠ ØºØ§Ù…Ù‚ */
            color: white;
            transition: all 0.2s;
        }
        #visualInterpretationButton:hover {
            background-color: #86198f;
            transform: translateY(-1px);
        }
        /* ØªØµÙ…ÙŠÙ… Ø²Ø± ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙÙ†ÙŠ */
        #nameArtButton {
            background-color: #10b981; /* Ø£Ø®Ø¶Ø± Ø²Ù…Ø±Ø¯ÙŠ */
            color: white;
            transition: all 0.2s;
        }
        #nameArtButton:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ğŸ¨ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØµÙˆÙŠØª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h1>
        
        <div id="authStatus" class="text-sm text-center text-gray-600 mb-4">ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...</div>
        <div id="userIdDisplay" class="text-xs text-center text-gray-500 mb-6 bg-gray-100 p-2 rounded-lg">
            Ù‡ÙˆÙŠØªÙƒ ÙƒÙ„Ø§Ø¹Ø¨ (Ø´Ø§Ø±ÙƒÙ‡Ø§ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ): <span id="currentUserId" class="font-mono text-blue-600 font-bold">...</span>
        </div>

        <!-- Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div id="gameScreens" class="space-y-8">
            
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù… -->
            <div id="drawingSection" class="border p-4 rounded-lg shadow-inner bg-blue-50">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">Ù…Ø±Ø­Ù„Ø© 1: Ø§Ø±Ø³Ù…</h2>
                
                <!-- Ù…ÙŠØ²Ø© Gemini Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙÙƒØ§Ø± (1) -->
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mb-4 rtl:sm:space-x-reverse items-center">
                    <button id="generatePrompt" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-200 text-sm flex items-center justify-center whitespace-nowrap disabled:opacity-50">
                        <span class="mr-2">âœ¨</span> ØªÙˆÙ„ÙŠØ¯ ÙÙƒØ±Ø© Ø±Ø³Ù… (Gemini AI)
                    </button>
                    <div id="promptOutput" class="flex-grow p-3 bg-indigo-100 border border-indigo-300 rounded-lg text-indigo-800 text-center font-semibold text-sm">
                        Ø§Ø¶ØºØ· Ù„ØªÙˆÙ„ÙŠØ¯ ÙÙƒØ±Ø©!
                    </div>
                </div>

                <div class="flex items-center space-x-4 mb-4 rtl:space-x-reverse">
                    <label for="colorPicker" class="font-medium text-gray-700">Ù„ÙˆÙ† Ø§Ù„Ù‚Ù„Ù…:</label>
                    <input type="color" id="colorPicker" value="#000000" class="w-8 h-8 rounded-full border-none p-0 cursor-pointer">
                    <label for="lineWidth" class="font-medium text-gray-700">Ø­Ø¬Ù… Ø§Ù„Ù‚Ù„Ù…:</label>
                    <input type="range" id="lineWidth" min="1" max="20" value="5" class="w-20">
                    <button id="clearCanvas" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200 text-sm">Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø©</button>
                </div>
                <!-- Canvas ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                <canvas id="drawingCanvas" class="w-full aspect-video rounded-lg shadow-lg"></canvas>

                <div class="mt-4 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 rtl:sm:space-x-reverse">
                    <input type="text" id="drawingDescription" placeholder="Ù…Ø§Ø°Ø§ Ø±Ø³Ù…ØªØŸ Ø£Ùˆ Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„ØªÙŠ ÙˆÙ„Ø¯ØªÙ‡Ø§" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button id="submitDrawing" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-200 whitespace-nowrap disabled:opacity-50" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ù… Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©</button>
                </div>
            </div>

            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØµÙˆÙŠØª -->
            <div id="votingSection" class="border p-4 rounded-lg shadow-inner bg-purple-50">
                <h2 class="text-xl font-semibold text-purple-700 mb-4">Ù…Ø±Ø­Ù„Ø© 2: ØªØµÙˆÙŠØª</h2>
                <div id="votingContent" class="text-center">
                    <div id="latestDrawing" class="mb-4">
                        <!-- Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø© Ù‡Ù†Ø§ -->
                        <p class="text-gray-500 mb-3">Ø§Ù†ØªØ¸Ø± Ø±Ø³Ù…Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ù…Ù† Ø£ÙŠ Ù„Ø§Ø¹Ø¨...</p>
                    </div>
                    
                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ù†Ù‚Ø¯ Gemini -->
                    <div id="critiqueArea" class="mt-4 p-3 bg-red-100 border border-red-300 rounded-lg hidden text-right">
                        <p id="critiqueText" class="text-red-800 text-sm italic font-medium">...</p>
                        <!-- Ù…ÙŠØ²Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØªÙŠØ© (4) -->
                        <button id="readCritiqueButton" class="mt-2 text-white font-bold py-1 px-3 rounded-lg shadow-md transition duration-200 text-xs flex items-center disabled:opacity-50">
                             ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Ù‚Ø¯ Ø¨ØµÙˆØª (TTS)
                        </button>
                    </div>
                    
                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„ÙÙ†ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (6) -->
                    <div id="newTitleArea" class="mt-4 p-3 bg-blue-100 border border-blue-300 rounded-lg hidden text-right">
                        <p id="newTitleText" class="text-blue-800 text-sm italic font-medium">...</p>
                    </div>


                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ø¨ØµØ±ÙŠ (5) -->
                    <div id="visualInterpretationArea" class="mt-4 p-3 bg-fuchsia-100 border border-fuchsia-300 rounded-lg hidden text-center">
                        <p class="text-fuchsia-800 text-sm font-medium mb-3">Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ Ù„Ù„Ù†Ù‚Ø¯ (Gemini Image):</p>
                        <div id="visualInterpretationImageContainer" class="flex justify-center">
                            <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆÙ„Ø¯Ø© Ù‡Ù†Ø§ -->
                        </div>
                    </div>

                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ø¹Ù…Ù‚ (3) -->
                    <div id="deepDiveArea" class="mt-4 p-3 bg-teal-100 border border-teal-300 rounded-lg hidden text-right">
                        <p id="deepDiveText" class="text-teal-800 text-sm font-medium">...</p>
                        <div id="deepDiveSources" class="text-xs mt-2 text-teal-600"></div>
                    </div>

                    <div class="flex flex-wrap gap-3 justify-center mt-4">
                        <button id="voteButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-200 disabled:opacity-30">
                            <span id="voteText">Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù„Ø±Ø³Ù… Ø£Ø¹Ù„Ø§Ù‡</span>
                        </button>
                        <button id="critiqueButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 disabled:opacity-30 text-sm flex items-center justify-center">
                            <span class="mr-2">âœ¨</span> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ù… (Gemini AI)
                        </button>
                        <button id="nameArtButton" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 disabled:opacity-30 text-sm flex items-center justify-center">
                            <span class="mr-2">âœ¨</span> ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙÙ†ÙŠ (Gemini AI)
                        </button>
                        <button id="deepDiveButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 disabled:opacity-30 text-sm flex items-center justify-center">
                            <span class="mr-2">âœ¨</span> Ø´Ø±Ø­ ÙÙƒØ±Ø© Ø§Ù„Ø±Ø³Ù… (Gemini AI)
                        </button>
                        <button id="visualInterpretationButton" class="bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 disabled:opacity-30 text-sm flex items-center justify-center">
                            <span class="mr-2">âœ¨</span> ØªÙØ³ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ù†Ù‚Ø¯ (Gemini Image)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
            <div id="resultsSection" class="border p-4 rounded-lg shadow-inner bg-yellow-50">
                <h2 class="text-xl font-semibold text-yellow-700 mb-4">Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨</h2>
                <div id="resultsList" class="space-y-3">
                    <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                </div>
                <button id="resetGameButton" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200 text-sm">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·)</button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, increment, getDocs, deleteDoc, getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙˆÙ‰ Ø³Ø¬Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„ØªØµØ­ÙŠØ­/Debugging)
        setLogLevel('debug');

        // Ù…ØªØºÙŠØ±Ø§Øª Firebase Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ÙŠØªÙ… ØªÙˆÙÙŠØ±Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¨ÙŠØ¦Ø©)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Ù…ØªØºÙŠØ±Ø§Øª Gemini API
        const geminiApiKey = ""; // Ø³ÙŠØªÙ… ØªÙˆÙÙŠØ±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø¨ÙŠØ¦Ø© Canvas
        // Text/Multimodal/Grounding Model
        const geminiContentModel = "gemini-2.5-flash-preview-09-2025";
        const geminiContentApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${geminiContentModel}:generateContent?key=${geminiApiKey}`;
        // TTS Model
        const geminiTtsModel = "gemini-2.5-flash-preview-tts";
        const geminiTtsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${geminiTtsModel}:generateContent?key=${geminiApiKey}`;
        // Image Generation Model
        const geminiImageModel = "imagen-3.0-generate-002";
        const geminiImageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${geminiImageModel}:predict?key=${geminiApiKey}`;


        let app, db, auth, userId = null;
        let latestDrawingId = null; // Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„ØªØµÙˆÙŠØª
        let hasVoted = false; // Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØµÙˆÙŠØª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø±Ø³Ù…
        let currentCritiqueText = ''; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†Ù‚Ø¯ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©
        let currentDrawingDataUrl = ''; // Ù„ØªØ®Ø²ÙŠÙ† URL Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØ³Ù…ÙŠØ©

        //-----------------------------------------
        // 1. ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Authentication)
        //-----------------------------------------

        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Base64 Ø¥Ù„Ù‰ ArrayBuffer 
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ PCM Ø¥Ù„Ù‰ WAV
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);

            // ÙˆØ¸ÙŠÙØ© Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ù„Ø§Ø³Ù„ ÙÙŠ DataView
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF'); // ChunkID
            view.setUint32(4, 36 + pcm16.length * 2, true); // ChunkSize
            writeString(view, 8, 'WAVE'); // Format

            // fmt chunk
            writeString(view, 12, 'fmt '); // Subchunk1ID
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, 1, true); // NumChannels (Mono)
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * 2, true); // ByteRate (SampleRate * NumChannels * BitsPerSample/8)
            view.setUint16(32, 2, true); // BlockAlign (NumChannels * BitsPerSample/8)
            view.setUint16(34, 16, true); // BitsPerSample

            // data chunk
            writeString(view, 36, 'data'); // Subchunk2ID
            view.setUint32(40, pcm16.length * 2, true); // Subchunk2Size

            // ÙƒØªØ§Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª PCM
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }
        
        // Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function initFirebase() {
            if (!firebaseConfig) {
                document.getElementById('authStatus').textContent = "Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.";
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('currentUserId').textContent = userId;
                        document.getElementById('authStatus').textContent = "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø¨.";
                        // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù…Ø¬Ø±Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                        document.getElementById('submitDrawing').disabled = false;
                        
                        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
                        listenForLatestDrawing();
                        listenForResults();
                    } else {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø®ØµØµ Ø£Ùˆ ÙƒÙ…Ø¬Ù‡ÙˆÙ„
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
                            document.getElementById('authStatus').textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.";
                        }
                    }
                });
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:", error);
                document.getElementById('authStatus').textContent = "Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ.";
            }
        }

        //-----------------------------------------
        // 2. Ù…Ù†Ø·Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù… (Canvas)
        //-----------------------------------------

        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('colorPicker');
        const lineWidthInput = document.getElementById('lineWidth');
        const clearCanvasButton = document.getElementById('clearCanvas');
        const submitDrawingButton = document.getElementById('submitDrawing');
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø¬Ù… Ø§Ù„Ù„ÙˆØ­Ø© Ø¨Ø´ÙƒÙ„ Ù…ØªØ¬Ø§ÙˆØ¨
        function setupCanvas() {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… CSS Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨ÙŠÙ†
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = lineWidthInput.value;
            ctx.strokeStyle = colorPicker.value;
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø³Ù… (Ø³ÙˆØ§Ø¡ Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ Ø£Ùˆ Ø§Ù„Ù„Ù…Ø³)
        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            [lastX, lastY] = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ù… (Ø³ÙˆØ§Ø¡ Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ Ø£Ùˆ Ø§Ù„Ù„Ù…Ø³)
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const [x, y] = getCoordinates(e);

            ctx.lineTo(x, y);
            ctx.stroke();
            [lastX, lastY] = [x, y];
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø§ÙˆØ³ ÙˆØ§Ù„Ù„Ù…Ø³
        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;

            if (e.touches && e.touches.length > 0) {
                // Ø­Ø¯Ø« Ø§Ù„Ù„Ù…Ø³
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                // Ø­Ø¯Ø« Ø§Ù„Ù…Ø§ÙˆØ³
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return [clientX - rect.left, clientY - rect.top];
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø³Ù…
        function stopDrawing() {
            isDrawing = false;
            ctx.closePath();
        }
        
        // Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø©
        clearCanvasButton.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ†
        colorPicker.addEventListener('input', () => {
            ctx.strokeStyle = colorPicker.value;
        });

        // ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù‚Ù„Ù…
        lineWidthInput.addEventListener('input', () => {
            ctx.lineWidth = lineWidthInput.value;
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„Ù…Ø³
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù„ÙˆØ­Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
        window.addEventListener('resize', setupCanvas);
        window.addEventListener('load', setupCanvas);
        
        //-----------------------------------------
        // 3.1. Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Gemini API Ù…Ø¹ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø§Ù„Ø£ÙØ³Ù‘ÙŠ (Exponential Backoff)
        //-----------------------------------------

        // Ø¯Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø§Ù„Ø£ÙØ³Ù‘ÙŠ (Exponential Backoff) Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆTTS
        async function callGeminiApiWithRetry(payload, apiUrl, retries = 3, useSearch = false) {
            
            // Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ Ø·Ù„Ø¨Øª
            if (useSearch) {
                payload.tools = [{ "google_search": {} }];
            }

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© TTS (ØµÙˆØª)
                    if (apiUrl === geminiTtsApiUrl) {
                         const part = result?.candidates?.[0]?.content?.parts?.[0];
                         const audioData = part?.inlineData?.data;
                         const mimeType = part?.inlineData?.mimeType;

                         if (audioData && mimeType && mimeType.startsWith("audio/")) {
                            const match = mimeType.match(/rate=(\d+)/);
                            const sampleRate = match ? parseInt(match[1], 10) : 16000;
                            const pcmData = base64ToArrayBuffer(audioData);
                            const pcm16 = new Int16Array(pcmData); // API returns signed PCM16
                            const wavBlob = pcmToWav(pcm16, sampleRate);
                            return { audioUrl: URL.createObjectURL(wavBlob) };
                         }
                         throw new Error("Invalid TTS response structure or missing audio data.");
                    }
                    
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Text/Multimodal/Grounding)
                    const candidate = result.candidates?.[0];
                    if (!candidate || !candidate.content?.parts?.[0]?.text) {
                        throw new Error("Invalid response structure or missing text from Gemini API");
                    }

                    const text = candidate.content.parts[0].text;
                    let sources = [];

                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø«
                    const groundingMetadata = candidate.groundingMetadata;
                    if (useSearch && groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø±
                    }

                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡
                    const cleanedText = text.trim().replace(/^['"\s]*|['"\s]*$/g, ''); 
                    
                    return { text: cleanedText, sources: sources };

                } catch (error) {
                    console.warn(`Gemini API call failed (Attempt ${i + 1}/${retries}). Retrying...`, error);
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø§Ù„Ø£ÙØ³Ù‘ÙŠ (Exponential Backoff) Ù„Ù†Ù…ÙˆØ°Ø¬ Imagen (ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±)
        async function callImagenApi(prompt, retries = 3) {
            const payload = { 
                instances: [{ prompt: prompt }], 
                parameters: { "sampleCount": 1 } 
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(geminiImageApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Imagen API returned status ${response.status}`);
                    }

                    const result = await response.json();
                    const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;

                    if (base64Data) {
                        return `data:image/png;base64,${base64Data}`;
                    }
                    throw new Error("Invalid Imagen response structure or missing image data.");

                } catch (error) {
                    console.warn(`Imagen API call failed (Attempt ${i + 1}/${retries}). Retrying...`, error);
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Base64 Ù…Ù† Data URL
        function extractBase64(dataUrl) {
            if (!dataUrl || !dataUrl.includes(',')) return '';
            return dataUrl.split(',')[1];
        }


        //-----------------------------------------
        // 3.2. Ù…Ù†Ø·Ù‚ ØªÙˆÙ„ÙŠØ¯ ÙÙƒØ±Ø© Ø§Ù„Ø±Ø³Ù… (Gemini AI Feature 1)
        //-----------------------------------------
        const generatePromptButton = document.getElementById('generatePrompt');
        const promptOutput = document.getElementById('promptOutput');

        generatePromptButton.addEventListener('click', async () => {
            generatePromptButton.disabled = true;
            promptOutput.innerHTML = '<span class="loader mx-auto"></span> Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ ÙÙƒØ±Ø©...';
            
            const systemPrompt = "Act as a creative game master. Your task is to generate a single, unique, fun, and challenging noun or short phrase (max 3 words) suitable for an online drawing game, like Pictionary. The concept should be drawable. Respond only with the prompt text and nothing else.";
            const userQuery = "Generate a drawing prompt in Arabic.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const { text: prompt } = await callGeminiApiWithRetry(payload, geminiContentApiUrl);
                
                document.getElementById('drawingDescription').value = prompt;
                promptOutput.textContent = `Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ù…ÙˆÙ„Ù‘Ø¯Ø©: "${prompt}"`;
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙÙƒØ±Ø© Ù…Ù† Gemini:", error);
                promptOutput.textContent = 'ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
            } finally {
                generatePromptButton.disabled = false;
            }
        });


        //-----------------------------------------
        // 3. Ù…Ù†Ø·Ù‚ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ù… Ø¥Ù„Ù‰ Firestore
        //-----------------------------------------

        const drawCollectionRef = (db) => collection(db, `/artifacts/${appId}/public/data/drawings`);
        const resultsCollectionRef = (db) => collection(db, `/artifacts/${appId}/public/data/results`);
        
        submitDrawingButton.addEventListener('click', async () => {
            if (!userId) {
                console.error("Ø®Ø·Ø£: ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„.");
                return;
            }

            submitDrawingButton.disabled = true;
            submitDrawingButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            const drawingDataURL = canvas.toDataURL('image/png');
            const description = document.getElementById('drawingDescription').value || 'Ø±Ø³Ù… Ø¨Ø¯ÙˆÙ† ÙˆØµÙ';
            
            try {
                // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù… ÙƒÙˆØ«ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Firestore
                const newDocRef = doc(drawCollectionRef(db));
                await setDoc(newDocRef, {
                    drawerId: userId,
                    description: description,
                    dataUrl: drawingDataURL, 
                    votes: 0,
                    voters: [], 
                    createdAt: Date.now()
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø£Ø®ÙŠØ±)
                const resultRef = doc(resultsCollectionRef(db), userId);
                await setDoc(resultRef, {
                    userId: userId,
                    totalVotes: 0, 
                    latestDrawingId: newDocRef.id,
                    lastDrawnAt: Date.now()
                }, { merge: true }); 

                console.log("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ù…Ø¹Ø±Ù:", newDocRef.id);
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø¨Ø³ÙŠØ·Ø©
                submitDrawingButton.textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰';
                document.getElementById('drawingDescription').value = ''; 
                promptOutput.textContent = 'Ø§Ø¶ØºØ· Ù„ØªÙˆÙ„ÙŠØ¯ ÙÙƒØ±Ø©!'; 
                setTimeout(() => {
                    submitDrawingButton.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ù… Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©';
                    submitDrawingButton.disabled = false;
                    ctx.clearRect(0, 0, canvas.width, canvas.height); // Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                }, 3000);
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ù…:", error);
                submitDrawingButton.textContent = 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ğŸ˜¢';
                setTimeout(() => {
                    submitDrawingButton.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ù… Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©';
                    submitDrawingButton.disabled = false;
                }, 3000);
            }
        });

        //-----------------------------------------
        // 4. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙˆÙŠØª ÙˆØ§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³ÙˆÙ…Ø§Øª
        //-----------------------------------------
        
        const votingContent = document.getElementById('votingContent');
        const voteButton = document.getElementById('voteButton');
        const latestDrawingContainer = document.getElementById('latestDrawing');
        const critiqueButton = document.getElementById('critiqueButton');
        const critiqueArea = document.getElementById('critiqueArea');
        const critiqueText = document.getElementById('critiqueText');
        const readCritiqueButton = document.getElementById('readCritiqueButton');
        const deepDiveButton = document.getElementById('deepDiveButton');
        const deepDiveArea = document.getElementById('deepDiveArea');
        const deepDiveText = document.getElementById('deepDiveText');
        const deepDiveSources = document.getElementById('deepDiveSources');
        const visualInterpretationButton = document.getElementById('visualInterpretationButton');
        const visualInterpretationArea = document.getElementById('visualInterpretationArea');
        const visualInterpretationImageContainer = document.getElementById('visualInterpretationImageContainer');
        const nameArtButton = document.getElementById('nameArtButton');
        const newTitleArea = document.getElementById('newTitleArea');
        const newTitleText = document.getElementById('newTitleText');

        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø« Ø±Ø³Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function listenForLatestDrawing() {
            // Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…: Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚
            const q = query(drawCollectionRef(db));
            
            onSnapshot(q, (snapshot) => {
                let latestDoc = null;
                let latestTimestamp = 0;
                
                // Ø§Ù„ÙØ±Ø² Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø­Ø¯Ø«
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.createdAt > latestTimestamp) {
                        latestTimestamp = data.createdAt;
                        latestDoc = doc;
                    }
                });

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†Ù‚Ø¯ ÙˆØ§Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ø¹Ù…Ù‚ ÙˆØ§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ ÙˆØ§Ù„ØªØ³Ù…ÙŠØ©
                critiqueArea.classList.add('hidden');
                critiqueText.textContent = '...';
                currentCritiqueText = ''; // Ù…Ø³Ø­ Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†
                readCritiqueButton.disabled = true;
                readCritiqueButton.textContent = 'ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Ù‚Ø¯ Ø¨ØµÙˆØª (TTS)';
                
                deepDiveArea.classList.add('hidden');
                deepDiveText.textContent = '...';
                deepDiveSources.innerHTML = '';

                visualInterpretationArea.classList.add('hidden');
                visualInterpretationImageContainer.innerHTML = '';

                newTitleArea.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                newTitleText.textContent = '...';
                
                if (latestDoc) {
                    const data = latestDoc.data();
                    
                    if (latestDrawingId === latestDoc.id && hasVoted) {
                        return;
                    }
                    
                    latestDrawingId = latestDoc.id;
                    currentDrawingDataUrl = data.dataUrl; // ØªØ®Ø²ÙŠÙ† URL Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    hasVoted = (data.voters || []).includes(userId); 

                    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ù…
                    latestDrawingContainer.innerHTML = `
                        <p class="text-sm text-gray-700 mb-2">Ø±Ø³Ù… Ø¨ÙˆØ§Ø³Ø·Ø©: <span class="font-mono text-blue-500">${data.drawerId}</span></p>
                        <p class="text-lg font-bold text-gray-800 mb-3" id="currentDrawingDescription">${data.description}</p>
                        <img src="${data.dataUrl}" alt="Latest Drawing" class="w-full h-auto rounded-lg shadow-lg border-4 border-purple-300 mx-auto max-w-sm">
                    `;
                    
                    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                    critiqueButton.setAttribute('data-url', data.dataUrl);
                    critiqueButton.setAttribute('data-description', data.description);
                    deepDiveButton.setAttribute('data-description', data.description);
                    nameArtButton.setAttribute('data-url', data.dataUrl);
                    nameArtButton.setAttribute('data-description', data.description);

                    // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨
                    if (data.drawerId === userId) {
                        voteButton.disabled = true;
                        voteButton.textContent = 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ Ø±Ø³Ù…Ùƒ!';
                        critiqueButton.disabled = true;
                        deepDiveButton.disabled = true;
                        visualInterpretationButton.disabled = true;
                        nameArtButton.disabled = true;
                    } else if (hasVoted) {
                        voteButton.disabled = true;
                        voteButton.textContent = 'Ù„Ù‚Ø¯ ØµÙˆØªØª Ø¨Ø§Ù„ÙØ¹Ù„ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø³Ù…!';
                        critiqueButton.disabled = false; 
                        deepDiveButton.disabled = false;
                        visualInterpretationButton.disabled = false;
                        nameArtButton.disabled = false;
                    }
                    else {
                        voteButton.disabled = false;
                        voteButton.textContent = 'Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù„Ø±Ø³Ù… Ø£Ø¹Ù„Ø§Ù‡';
                        critiqueButton.disabled = false;
                        deepDiveButton.disabled = false;
                        visualInterpretationButton.disabled = false;
                        nameArtButton.disabled = false;
                    }
                    
                } else {
                    latestDrawingContainer.innerHTML = '<p class="text-gray-500 mb-3">Ø§Ù†ØªØ¸Ø± Ø±Ø³Ù…Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ù…Ù† Ø£ÙŠ Ù„Ø§Ø¹Ø¨...</p>';
                    voteButton.disabled = true;
                    critiqueButton.disabled = true;
                    deepDiveButton.disabled = true;
                    visualInterpretationButton.disabled = true;
                    nameArtButton.disabled = true;
                    voteButton.textContent = 'Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù„Ø±Ø³Ù… Ø£Ø¹Ù„Ø§Ù‡';
                }
            });
        }
        
        //-----------------------------------------
        // 4.1. Ù…Ù†Ø·Ù‚ Ù†Ù‚Ø¯ Ø§Ù„Ø±Ø³Ù… (Gemini AI Feature 2 - Multimodal)
        //-----------------------------------------

        critiqueButton.addEventListener('click', async () => {
            if (!latestDrawingId || !userId) return;

            const drawingDataUrl = critiqueButton.getAttribute('data-url');
            const description = critiqueButton.getAttribute('data-description');
            
            if (!drawingDataUrl || !description) {
                critiqueText.textContent = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©.';
                critiqueArea.classList.remove('hidden');
                readCritiqueButton.disabled = true;
                visualInterpretationButton.disabled = true;
                return;
            }

            const base64Image = extractBase64(drawingDataUrl);

            critiqueButton.disabled = true;
            critiqueButton.innerHTML = '<span class="loader w-4 h-4 mr-2"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...';
            critiqueArea.classList.add('hidden');
            readCritiqueButton.disabled = true;
            visualInterpretationButton.disabled = true; 
            
            try {
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙˆØ¬Ù‡ Ø§Ù„Ù†Ø¸Ø§Ù… (System Prompt) Ù„Ù„Ù†Ø§Ù‚Ø¯ Ø§Ù„ÙÙ†ÙŠ
                const systemPrompt = "Act as a playful, slightly sarcastic art critic specializing in Pictionary. You must provide a short, one-paragraph critique (max 50 words) of the drawing, focusing on how well it visually captures the intended subject. Use a humorous and encouraging tone. Respond only with the critique text.";
                
                const userQuery = `Critique this drawing. The intended subject/prompt was: ${description}`;

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userQuery },
                                {
                                    inlineData: {
                                        mimeType: "image/png",
                                        data: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                
                const { text: critique } = await callGeminiApiWithRetry(payload, geminiContentApiUrl);
                
                critiqueText.innerHTML = `**Ù†Ù‚Ø¯ Ø§Ù„Ù†Ø§Ù‚Ø¯ Ø§Ù„ÙÙ†ÙŠ:** ${critique}`;
                currentCritiqueText = critique; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†Ù‚Ø¯ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©
                critiqueArea.classList.remove('hidden');
                readCritiqueButton.disabled = false; // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø¯
                visualInterpretationButton.disabled = false; // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ù… Ù…Ù† Gemini:", error);
                critiqueText.textContent = 'ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…. Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø§Ù‚Ø¯ Ø§Ù„ÙÙ†ÙŠ.';
                critiqueArea.classList.remove('hidden');
            } finally {
                critiqueButton.disabled = false;
                critiqueButton.innerHTML = '<span class="mr-2">âœ¨</span> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ù… (Gemini AI)';
            }
        });

        //-----------------------------------------
        // 4.5. Ù…Ù†Ø·Ù‚ ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙÙ†ÙŠ (Gemini AI Feature 6 - Multimodal)
        //-----------------------------------------
        nameArtButton.addEventListener('click', async () => {
            if (!latestDrawingId || !userId) return;

            const drawingDataUrl = nameArtButton.getAttribute('data-url');
            const description = nameArtButton.getAttribute('data-description');
            
            if (!drawingDataUrl || !description) {
                newTitleText.textContent = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙÙ†ÙŠ. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©.';
                newTitleArea.classList.remove('hidden');
                return;
            }

            const base64Image = extractBase64(drawingDataUrl);

            nameArtButton.disabled = true;
            nameArtButton.innerHTML = '<span class="loader w-4 h-4 mr-2"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ù…ÙŠØ©...';
            newTitleArea.classList.add('hidden');
            
            try {
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙˆØ¬Ù‡ Ø§Ù„Ù†Ø¸Ø§Ù… (System Prompt) Ù„Ù„Ù‚ÙŠÙ‘Ù… Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø¯Ø±Ø§Ù…ÙŠ
                const systemPrompt = "Act as a dramatic, poetic art curator. Based on the drawing and its original description, generate a single, highly evocative and poetic title for the artwork. The title must be in Arabic and suitable for a museum plaque. Respond only with the title text and nothing else.";
                
                const userQuery = `Original subject/description: ${description}. Generate a new, artistic title for this image.`;

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userQuery },
                                {
                                    inlineData: {
                                        mimeType: "image/png",
                                        data: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                
                const { text: newTitle } = await callGeminiApiWithRetry(payload, geminiContentApiUrl);
                
                newTitleText.innerHTML = `**Ø¹Ù†ÙˆØ§Ù† Ù…ØªØ­ÙÙŠ Ù…Ù‚ØªØ±Ø­:** <span class="text-lg">${newTitle}</span>`;
                newTitleArea.classList.remove('hidden');

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙÙ†ÙŠ Ù…Ù† Gemini:", error);
                newTitleText.textContent = 'ÙØ´Ù„ ÙÙŠ ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…Ù„. Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚ÙŠÙ‘Ù… Ø§Ù„ÙÙ†ÙŠ.';
                newTitleArea.classList.remove('hidden');
            } finally {
                nameArtButton.disabled = false;
                nameArtButton.innerHTML = '<span class="mr-2">âœ¨</span> ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙÙ†ÙŠ (Gemini AI)';
            }
        });


        //-----------------------------------------
        // 4.3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØªÙŠØ© (Gemini AI Feature 4 - TTS)
        //-----------------------------------------
        
        readCritiqueButton.addEventListener('click', async () => {
            const textToRead = critiqueText.textContent.replace('**Ù†Ù‚Ø¯ Ø§Ù„Ù†Ø§Ù‚Ø¯ Ø§Ù„ÙÙ†ÙŠ:**', '').trim();
            
            if (!textToRead || textToRead === '...') {
                console.warn('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù‚Ø±Ø§Ø¡ØªÙ‡.');
                return;
            }

            readCritiqueButton.disabled = true;
            readCritiqueButton.innerHTML = '<span class="loader w-4 h-4 mr-2"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...';
            
            const payload = {
                contents: [{
                    parts: [{ text: textToRead }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } // ØµÙˆØª Ø«Ø§Ø¨Øª ÙˆÙ…Ù†Ø§Ø³Ø¨
                        }
                    }
                },
            };

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… geminiTtsApiUrl Ù‡Ù†Ø§
                const { audioUrl } = await callGeminiApiWithRetry(payload, geminiTtsApiUrl);
                
                const audio = new Audio(audioUrl);
                audio.play();

                audio.onended = () => {
                    readCritiqueButton.disabled = false;
                    readCritiqueButton.innerHTML = 'ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Ù‚Ø¯ Ø¨ØµÙˆØª (TTS)';
                };
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª TTS:", error);
                readCritiqueButton.innerHTML = 'âŒ ÙØ´Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©';
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø©
                setTimeout(() => {
                    readCritiqueButton.disabled = false;
                    readCritiqueButton.innerHTML = 'ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Ù‚Ø¯ Ø¨ØµÙˆØª (TTS)';
                }, 3000);
            }
        });
        
        //-----------------------------------------
        // 4.4. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ Ù„Ù„Ù†Ù‚Ø¯ (Gemini AI Feature 5 - Imagen)
        //-----------------------------------------

        visualInterpretationButton.addEventListener('click', async () => {
            // ÙŠØªØ·Ù„Ø¨ Ù†Ù‚Ø¯Ù‹Ø§ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ù„ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            const critique = currentCritiqueText;
            const description = critiqueButton.getAttribute('data-description');

            if (!critique || critique === '...' || !description || description === 'Ø±Ø³Ù… Ø¨Ø¯ÙˆÙ† ÙˆØµÙ') {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ Ø¨Ø¹Ø¯
                visualInterpretationImageContainer.innerHTML = '<p class="text-fuchsia-800">ÙŠØ±Ø¬Ù‰ Ø£ÙˆÙ„Ø§Ù‹ ØªØ´ØºÙŠÙ„ Ø²Ø± "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„ÙÙ†ÙŠ.</p>';
                visualInterpretationArea.classList.remove('hidden');
                return;
            }

            visualInterpretationButton.disabled = true;
            visualInterpretationButton.innerHTML = '<span class="loader w-4 h-4 mr-2"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...';
            visualInterpretationImageContainer.innerHTML = '<div class="loader"></div>';
            visualInterpretationArea.classList.remove('hidden');
            
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¬Ù‡ ÙŠØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„ÙˆØµÙ (Ù…Ø§ Ù‡Ùˆ) ÙˆØ§Ù„Ù†Ù‚Ø¯ (Ø§Ù„Ø£Ø³Ù„ÙˆØ¨/Ø§Ù„Ø´Ø¹ÙˆØ±)
                const imagePrompt = `A surreal, playful, artistic interpretation of the subject: "${description}", rendered in a style that reflects the critique: "${critique}". Focus on artistic texture and whimsical elements.`;
                
                const imageUrl = await callImagenApi(imagePrompt);
                
                visualInterpretationImageContainer.innerHTML = `<img src="${imageUrl}" alt="AI Visual Interpretation" class="max-w-xs md:max-w-sm rounded-lg shadow-xl mx-auto border-4 border-fuchsia-400">`;

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Imagen:", error);
                visualInterpretationImageContainer.innerHTML = '<p class="text-red-600">ÙØ´Ù„ Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ. Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„ØµÙˆØ±Ø©.</p>';
            } finally {
                visualInterpretationButton.disabled = false;
                visualInterpretationButton.innerHTML = '<span class="mr-2">âœ¨</span> ØªÙØ³ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ù†Ù‚Ø¯ (Gemini Image)';
            }
        });


        //-----------------------------------------
        // 4.2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ø¹Ù…Ù‚ (Gemini AI Feature 3 - Grounding)
        //-----------------------------------------
        
        deepDiveButton.addEventListener('click', async () => {
            if (!latestDrawingId || !userId) return;

            const description = deepDiveButton.getAttribute('data-description');
            
            if (!description || description === 'Ø±Ø³Ù… Ø¨Ø¯ÙˆÙ† ÙˆØµÙ') {
                deepDiveText.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø±Ø³Ù… ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡.';
                deepDiveArea.classList.remove('hidden');
                return;
            }

            deepDiveButton.disabled = true;
            deepDiveButton.innerHTML = '<span class="loader w-4 h-4 mr-2"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø´Ø±Ø­...';
            deepDiveArea.classList.add('hidden');
            deepDiveSources.innerHTML = '';
            
            try {
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙˆØ¬Ù‡ Ø§Ù„Ù†Ø¸Ø§Ù… (System Prompt) Ù„Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ø¹Ù…Ù‚
                const systemPrompt = "Act as an informative, concise encyclopedia assistant. Provide a brief, single-paragraph explanation (max 70 words) about the subject provided by the user. Ensure the explanation is based on grounded search results. Respond only with the explanation text.";
                
                const userQuery = `What is "${description}"? Explain it concisely in Arabic.`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… useSearch: true Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ø­Ø« Google
                const { text: explanation, sources } = await callGeminiApiWithRetry(payload, geminiContentApiUrl, 3, true);
                
                deepDiveText.innerHTML = `**Ù…Ø®ØªØµØ± Ø§Ù„ÙÙƒØ±Ø©:** ${explanation}`;
                
                if (sources.length > 0) {
                    deepDiveSources.innerHTML = `<p class="font-bold mt-2">Ø§Ù„Ù…ØµØ§Ø¯Ø±:</p>
                        ${sources.map(s => 
                            `<a href="${s.uri}" target="_blank" class="text-blue-500 hover:text-blue-700 truncate block">${s.title}</a>`
                        ).join('')}`;
                } else {
                    deepDiveSources.innerHTML = '<p class="mt-2">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ØµØ§Ø¯Ø± Ø¥Ø¶Ø§ÙÙŠØ©.</p>';
                }
                
                deepDiveArea.classList.remove('hidden');

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ø¹Ù…Ù‚ Ù…Ù† Gemini:", error);
                deepDiveText.textContent = 'ÙØ´Ù„ Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ø¹Ù…Ù‚. Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«.';
                deepDiveArea.classList.remove('hidden');
            } finally {
                deepDiveButton.disabled = false;
                deepDiveButton.innerHTML = '<span class="mr-2">âœ¨</span> Ø´Ø±Ø­ ÙÙƒØ±Ø© Ø§Ù„Ø±Ø³Ù… (Gemini AI)';
            }
        });


        // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙˆÙŠØª
        voteButton.addEventListener('click', async () => {
            if (!latestDrawingId || hasVoted || !userId) return;

            const drawingRef = doc(drawCollectionRef(db), latestDrawingId);
            
            voteButton.disabled = true;
            voteButton.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª...';

            try {
                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµÙˆØªÙŠÙ† (Voters)
                const latestDocSnapshot = await getDoc(drawingRef);
                const data = latestDocSnapshot.data();
                const currentVoters = data.voters || [];
                const drawerId = data.drawerId;
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù… ÙŠØµÙˆØª (Ù…Ù‡Ù… Ù„Ù…Ù†Ø¹ Ø§Ù„Ø³Ø¨Ø§Ù‚)
                if (currentVoters.includes(userId)) {
                    voteButton.textContent = 'Ù„Ù‚Ø¯ ØµÙˆØªØª Ø¨Ø§Ù„ÙØ¹Ù„ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø³Ù…!';
                    hasVoted = true;
                    return;
                }

                // 2. Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø±Ø³Ù… ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµÙˆØªÙŠÙ†
                await updateDoc(drawingRef, {
                    votes: increment(1),
                    voters: [...currentVoters, userId]
                });
                
                // 3. ØªØ­Ø¯ÙŠØ« Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ÙƒÙ„ÙŠ ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø±Ø³Ø§Ù…
                const resultRef = doc(resultsCollectionRef(db), drawerId);
                
                await setDoc(resultRef, {
                    totalVotes: increment(1)
                }, { merge: true }); // ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© increment

                hasVoted = true;
                console.log(`ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ù… ${latestDrawingId}`);
                voteButton.textContent = 'ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª! Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ. âœ…';
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª:", error);
                voteButton.disabled = false;
                voteButton.textContent = 'ÙØ´Ù„ Ø§Ù„ØªØµÙˆÙŠØª âŒ';
            }
        });

        //-----------------------------------------
        // 5. Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        //-----------------------------------------

        const resultsList = document.getElementById('resultsList');
        const resetGameButton = document.getElementById('resetGameButton');
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØµÙˆÙŠØª
        function listenForResults() {
            const q = query(resultsCollectionRef(db));
            
            onSnapshot(q, (snapshot) => {
                let results = [];
                snapshot.forEach(doc => {
                    results.push(doc.data());
                });

                // ÙØ±Ø² Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ØµÙˆØ§Øª
                results.sort((a, b) => b.totalVotes - a.totalVotes);

                if (results.length === 0) {
                    resultsList.innerHTML = '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ÙˆØ§ Ø¨Ø§Ù„Ø±Ø³Ù…!</p>';
                    return;
                }
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                resultsList.innerHTML = results.map((result, index) => `
                    <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border-r-4 ${index === 0 ? 'border-yellow-500 font-bold' : 'border-gray-200'}">
                        <span class="text-xl w-8 text-center">${index + 1}</span>
                        <span class="font-mono text-sm text-gray-700 flex-grow mx-4">${result.userId}</span>
                        <span class="text-2xl text-red-600 font-extrabold">${result.totalVotes}</span>
                        <span class="text-sm text-gray-500 mr-2">ØµÙˆØª</span>
                    </div>
                `).join('');
            });
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ù„Ù„Ù…Ø´Ø±Ù/Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·)
        resetGameButton.addEventListener('click', async () => {
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ confirm Ø¨Ù€ Ù†Ø§ÙØ°Ø© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø®ØµØµØ© ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠ
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ Ù‡Ø°Ø§ Ø³ÙŠØ­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬!')) {
                return;
            }
            
            resetGameButton.disabled = true;
            resetGameButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';
            
            try {
                // Ø­Ø°Ù ÙƒÙ„ ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª
                const drawingsSnapshot = await getDocs(drawCollectionRef(db));
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„Ø¶Ù…Ø§Ù† Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø°Ù
                await Promise.all(drawingsSnapshot.docs.map(doc => deleteDoc(doc.ref)));
                
                // Ø­Ø°Ù ÙƒÙ„ ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                const resultsSnapshot = await getDocs(resultsCollectionRef(db));
                await Promise.all(resultsSnapshot.docs.map(doc => deleteDoc(doc.ref)));

                resetGameButton.textContent = 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰';
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©:", error);
                resetGameButton.textContent = 'ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† ğŸ˜¢';
            } finally {
                setTimeout(() => {
                    resetGameButton.disabled = false;
                    resetGameButton.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·)';
                }, 3000);
            }
        });
        

        // Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø©
        window.addEventListener('load', initFirebase);
    </script>
</body>
</html>
